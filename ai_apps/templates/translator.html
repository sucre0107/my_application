{% extends "base_for_ai_apps.html" %}
{% load static %}

{% block title %}
	翻译助手
{% endblock title %}


{% block content %}
	<div class="relative mt-10">
		<form class="block w-3/4 mx-auto" novalidate>
			{% csrf_token %}
			{% for field in form %}
				<div class="my-2">
					<label class="text-xl block mb-3" for="{{ field.name }}">{{ field.label }}</label>
					{{ field }}
					{{ endfor }}
				</div>
			{% endfor %}

			<button id="stopbtn"
					class="my-5 bg-blue-500 hover:bg-blue-700 text-white text-xl font-bold py-3 px-8 rounded"
					type="button">停止
			</button>

			<button id="translateBtn"
					class="w-full my-5 bg-blue-500 hover:bg-blue-700 text-white text-xl font-bold py-3 rounded"
					type="button">
				翻译
			</button>
		</form>
	</div>


	<script src="{% static 'js/jquery.js' %}"></script>
	<script src="{% static 'js/csrf.js' %}"></script>

	<script>
        $(function () {
            // 点击翻译事件
            $('#translateBtn').click(function () {
                streamEvent();
            });
            // 点击停止事件
            $('#stopbtn').click(function () {
                stopGernerateEvent();
            });
            clearOldTranslation();

        });

        let lastText = ''

        function streamEvent() {
            text = $('#id_text').val()
            // 如果内容相同，不连接后端，省钱
            if (text == lastText) {
                alert('请勿重复提交')
                return
            } else {
                lastText = text
            }
            // 判断text有没有内容
            if (!text) {
                // 内容为空不连接后端，省钱
                alert('请输入要翻译的内容')
            } else {
                // 内容不为空，连接后端
                stop = "false"  // 设置get请求的stop参数，在后端判断是否停止
                const eventSource = new EventSource(`{% url 'pack_trans_stream' %}?text=${text}&stop=${stop}`);
                eventSource.addEventListener('message', function (e) {
                    const data = e.data;
                    if (data == '') {
                        eventSource.close();
                    } else {
                        console.log("data:", data, typeof (data)) // 输出data,是string类型
						// newStr = data.slice(2, -1)
						// console.log("new_data:", new_data, typeof (new_data)) // 输出data,是string类型
                        // 获取id=id_translation的textarea框
                        output = document.getElementById('id_translation');
                        // 输出data

                        output.value += data;
                    }


                });
                // 处理连接断开的情况
                eventSource.addEventListener('error', function () {
                    console.error('连接已断开', "error");
                    // 如果需要，可以尝试重新连接
                });
            }
        }

        function stopGernerateEvent() {
            stop = "true"
            const eventSource = new EventSource(`{% url 'pack_trans_stream' %}?text=${text}&stop=${stop}`);
            eventSource.close()

        }

        // 当id=id_text的input框的值发生改变时，清空id=id_translation的input框的值
        function clearOldTranslation() {
            $('#id_text').change(function () {
                $('#id_translation').val('')
            })
        }


	</script>
{% endblock %}