{% extends 'base_for_pknight_docs.html' %}
{% load static %}

{% block title %}
	Art-Net & sACN Universe Converter
{% endblock title %}


{% block content %}

  <div style="text-align: right; padding: 12px 24px 0;">
    <span style="font-weight: 600; font-size: 1.03em; color: #444;">Language / 语言：</span>
    <select id="langSelect" onchange="switchLanguage()" style="font-size: 1em; margin-left: 4px;">
      <option value="zh">中文</option>
      <option value="en">English</option>
    </select>
  </div>
  <div class="max-w-2xl mt-12 mx-auto bg-white shadow-xl rounded-2xl p-8 relative">
    <h1 id="pageTitle" class="text-3xl font-extrabold text-blue-700 tracking-wide mb-6 text-center leading-tight">Art-Net & sACN Universe 转换工具</h1>
    <p id="productNote" class="mt-0 mb-5 text-gray-700 text-center bg-blue-50 border border-blue-200 rounded-lg p-3 shadow-sm text-sm">
      本工具适用于 Pknight 控制类产品，包括 CR011R MK II、CR021R MK II、CR041R MK II 等。
    </p>

    <div>
      <h2 class="section-title text-xl font-bold text-blue-800 mb-2 flex items-center">
        <span id="forwardTitle">正向转换</span>
        <span class="tooltip ml-2 cursor-pointer rounded-full px-2 py-0.5 bg-blue-100 text-blue-600 font-semibold text-sm" id="forwardTip">?</span>
      </h2>
      <label class="block font-semibold text-gray-600 mb-1 text-lg">
        <span class="lang-text">请输入第几个‘域’（Universe 从 1 开始计数）：</span>
        <input type="number" id="universeInput" min="1" max="63999" value="1" autocomplete="off" class="w-30 px-3 py-2 border border-gray-300 rounded-md text-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-400">
      </label>
      <button onclick="convertUniverse()" class="inline-block px-6 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold text-lg rounded-md shadow-md hover:from-blue-700 hover:to-blue-600 active:scale-95 transition-transform mb-1">
        编码 Universe
      </button>
      <div class="result mt-5 bg-blue-50 p-4 rounded-md border-l-4 border-blue-400 text-gray-800 text-base break-words leading-relaxed shadow-sm" id="result"></div>
    </div>

    <div class="section border-t-2 border-dashed border-blue-300 mt-10 pt-7">
      <h2 class="section-title text-xl font-bold text-blue-800 mb-2 flex items-center">
        <span id="reverseTitle">反向计算</span>
        <span class="tooltip ml-2 cursor-pointer rounded-full px-2 py-0.5 bg-blue-100 text-blue-600 font-semibold text-sm" id="reverseTip">?</span>
      </h2>
      <label class="block font-semibold text-gray-600 mb-2 text-lg">
        <span class="lang-text">请输入 Net / Subnet / Universe：</span>
      </label>
      <div class="flex gap-3 flex-wrap mb-2">
        <input type="number" id="revNet" min="0" max="127" placeholder="Net" value="0" class="w-20 px-3 py-2 border border-gray-300 rounded-md text-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
        <input type="number" id="revSub" min="0" max="15" placeholder="Subnet" value="0" class="w-20 px-3 py-2 border border-gray-300 rounded-md text-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
        <input type="number" id="revUni" min="0" max="15" placeholder="Universe" value="1" class="w-20 px-3 py-2 border border-gray-300 rounded-md text-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
      </div>
      <button onclick="reverseCalc()" class="inline-block px-6 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold text-lg rounded-md shadow-md hover:from-blue-700 hover:to-blue-600 active:scale-95 transition-transform mb-1">
        反算 Universe 编号
      </button>
      <div class="result mt-5 bg-blue-50 p-4 rounded-md border-l-4 border-blue-400 text-gray-800 text-base break-words leading-relaxed shadow-sm" id="reverseResult"></div>
    </div>
</div>

  <div class="text-center text-gray-500 text-sm mt-5 mb-5">
    © 2025 Pknight. Tool built exclusively for official hardware.
  </div>

  <script>
    // 域名校验（仅允许 pknight.cc、127.0.0.1:5500、localhost 访问）
    const hostname = location.hostname + (location.port ? ':' + location.port : '');
    const allowlist = ['pknight.cc', '127.0.0.1:5500','127.0.0.1:8000', 'localhost'];
    if (!allowlist.some(allowed => hostname.includes(allowed))) {
      document.body.innerHTML = '<h2 style="color:red;text-align:center;margin-top:20vh;">This tool is only accessible from the official domain.</h2>';
      throw new Error('Unauthorized domain');
    }

    // 禁用右键和 F12 / Ctrl+Shift+I
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
      if (
        e.key === 'F12' ||
        (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C'))
      ) {
        e.preventDefault();
      }
    });
    // 按下Enter自动触发
    document.addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        if (document.activeElement.id === "universeInput") convertUniverse();
        if (
          document.activeElement.id === "revNet" ||
          document.activeElement.id === "revSub" ||
          document.activeElement.id === "revUni"
        ) reverseCalc();
      }
    });

    function convertUniverse() {
      const btn = document.querySelectorAll("button")[0];
      btn.classList.add("clicked");
      setTimeout(() => btn.classList.remove("clicked"), 200);

      let u = parseInt(document.getElementById("universeInput").value, 10);
      if (isNaN(u) || u < 1 || u > 63999) {
        document.getElementById("result").innerHTML = "⚠️ 请输入 1~63999 范围内的整数。";
        return;
      }
      const base = u - 1;
      const artNet = {
        net: Math.floor(base / 256),
        sub: Math.floor((base % 256) / 16),
        uni: base % 16
      };
      let sacnNet, sacnSub, sacnUni;
      if (u <= 15) {
        sacnNet = 0;
        sacnSub = 0;
        sacnUni = u;
      } else {
        let base2 = u - 16;
        sacnNet = Math.floor(base2 / 256);
        sacnSub = Math.floor((base2 % 256) / 16) + 1;
        sacnUni = base2 % 16;
      }
      const sacnMulticast = `239.255.${u >> 8}.${u & 0xFF}`;
      const lang = document.getElementById("langSelect").value;
      const map = langMap[lang];

      document.getElementById("result").innerHTML = `
        <span class="title">${map.artnetTitle}</span><br>
        ${map.universeLabel0}: <code>${base}</code><br>
        Net: <code>${artNet.net}</code><br>
        Subnet: <code>${artNet.sub}</code><br>
        Universe: <code>${artNet.uni}</code><br><br>
        <span class="title">${map.sacnTitle}</span><br>
        ${map.universeLabel1}: <code>${u}</code><br>
        Net: <code>${sacnNet}</code><br>
        Subnet: <code>${sacnSub}</code><br>
        Universe: <code>${sacnUni}</code><br>
        ${map.multicastLabel}: <code>${sacnMulticast}</code>
      `;
    }

    function reverseCalc() {
      let net = parseInt(document.getElementById("revNet").value, 10);
      let sub = parseInt(document.getElementById("revSub").value, 10);
      let uni = parseInt(document.getElementById("revUni").value, 10);
      if (
        isNaN(net) || net < 0 || net > 127 ||
        isNaN(sub) || sub < 0 || sub > 15 ||
        isNaN(uni) || uni < 0 || uni > 15
      ) {
        document.getElementById("reverseResult").innerHTML = "⚠️ 请输入合法的 Net(0~127), Subnet(0~15), Universe(0~15)。";
        return;
      }
      const artnetUniverse = net * 256 + sub * 16 + uni;
      let sacnUniverse = null, sacnMulticast = "";
      const map = langMap[document.getElementById("langSelect").value];
      if (net === 0 && sub === 0 && uni >= 1 && uni <= 15) {
        sacnUniverse = uni;
      } else if (!(net === 0 && sub === 0)) {
        sacnUniverse = net * 256 + (sub - 1) * 16 + uni + 16;
      } else {
        sacnUniverse = map.invalidCombo;
      }
      if (typeof sacnUniverse === "number") {
        sacnMulticast = `239.255.${sacnUniverse >> 8}.${sacnUniverse & 0xFF}`;
      }
      document.getElementById("reverseResult").innerHTML = `
        <span class="title">${map.artnetReverseTitle}</span><br>
        ${map.universeLabel0}: <code>${artnetUniverse}</code><br>
        ${map.universeIndexLabel}: <code>${artnetUniverse + 1}</code><br><br>
        <span class="title">${map.sacnReverseTitle}</span><br>
        ${map.universeLabel1}: <code>${sacnUniverse}</code><br>
        ${typeof sacnUniverse === "number" ? `${map.universeIndexLabel}: <code>${sacnUniverse}</code><br>` : ""}
        ${map.multicastLabel}: <code>${sacnMulticast}</code>
      `;
    }

    // 语言切换脚本
    const langMap = {
      zh: {
        pageTitle: "Art-Net & sACN Universe 转换工具",
        forwardTitle: "正向转换",
        forwardLabel: "请输入第几个‘域’（Universe 从 1 开始计数）：",
        forwardBtn: "编码 Universe",
        reverseTitle: "反向计算",
        reverseLabel: "请输入 Net / Subnet / Universe：",
        reverseBtn: "反算 Universe",
        artnetTitle: "Art-Net 设置",
        sacnTitle: "sACN 设置（自定义分段）",
        universeLabel0: "Universe 编号（从 0 开始）",
        universeIndexLabel: "Universe 序号（从 1 开始）",
        universeLabel1: "Universe 编号（从 1 开始）",
        multicastLabel: "Multicast 地址",
        forwardTip: "根据 Universe 序号（第几个 DMX域）\n计算 Art-Net 与 sACN 需要配置的 Net/Subnet/Universe 等参数",
        reverseTip: "输入 Net/Subnet/Universe 参数\n反算对应的 Universe 编号。",
        artnetReverseTitle: "Art-Net 反算结果",
        sacnReverseTitle: "sACN 反算结果（自定义分段）",
        invalidCombo: "非法组合",
        productNote: "本工具适用于 Pknight 控制类产品，包括 CR011R MK II、CR021R MK II、CR041R MK II 等。",
      },
      en: {
        pageTitle: "Art-Net & sACN Universe Converter",
        forwardTitle: "Universe to Address",
        forwardLabel: "Enter the Universe index (1-based):",
        forwardBtn: "Encode Universe",
        reverseTitle: "Address to Universe",
        reverseLabel: "Enter Net / Subnet / Universe:",
        reverseBtn: "Decode Universe",
        artnetTitle: "Art-Net Configuration",
        sacnTitle: "sACN Configuration (custom segmentation)",
        universeLabel0: "Universe ID (starting from 0)",
        universeIndexLabel: "Universe Index (1-based)",
        universeLabel1: "Universe ID (starting from 1)",
        multicastLabel: "Multicast Address",
        forwardTip: "Given a Universe index (1-based),\ncalculate the Net / Subnet / Universe values for Art-Net and sACN.",
        reverseTip: "Given a Net / Subnet / Universe,\ncalculate the corresponding Universe index.",
        artnetReverseTitle: "Art-Net Reverse Result",
        sacnReverseTitle: "sACN Reverse Result (custom segmentation)",
        invalidCombo: "Invalid Combination",
        productNote: "This calculator is designed for Pknight products including CR011R MK II, CR021R MK II, CR041R MK II.",
      }
    };

    function switchLanguage() {
      const lang = document.getElementById("langSelect").value;
      const map = langMap[lang];
      document.getElementById("pageTitle").textContent = map.pageTitle;
      document.getElementById("productNote").textContent = map.productNote;
      document.getElementById("forwardTitle").textContent = map.forwardTitle;
      document.querySelectorAll(".lang-text")[0].textContent = map.forwardLabel;
      document.querySelectorAll("button")[0].textContent = map.forwardBtn;
      document.getElementById("reverseTitle").textContent = map.reverseTitle;
      document.querySelectorAll(".lang-text")[1].textContent = map.reverseLabel;
      document.querySelectorAll("button")[1].textContent = map.reverseBtn;
      document.getElementById("forwardTip").setAttribute("data-tip", map.forwardTip);
      document.getElementById("reverseTip").setAttribute("data-tip", map.reverseTip);
      document.getElementById("result").innerHTML = "";
      document.getElementById("reverseResult").innerHTML = "";
    }
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("langSelect").value = "en";
      switchLanguage();
    });
  </script>







{% endblock content %}